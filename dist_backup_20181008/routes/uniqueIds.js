'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _express = require('express');

var _express2 = _interopRequireDefault(_express);

var _config = require('../config/config.json');

var _config2 = _interopRequireDefault(_config);

var _logger = require('../libs/logger');

var _logger2 = _interopRequireDefault(_logger);

var _async = require('async');

var _async2 = _interopRequireDefault(_async);

var _moment = require('moment');

var _moment2 = _interopRequireDefault(_moment);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var router = _express2.default.Router();

var CODES_CHUNK = 100;
var MAX_CODES = 500;
var createRandom = function createRandom(l) {
  var string = '';
  var letters = 'abcdefghilmnopqrstuvzxwykjABCDEFGHILMNOPQRSTUVZXWYKJ1234567890';
  for (var i = 0; i < l; i += 1) {
    var pos = Math.floor(Math.random() * (letters.length - 0) + 0);
    string += letters[pos];
  }
  return string;
};
var getCodes = function getCodes(howMany, CODE_LEN) {
  var generated = {};
  while (howMany > 0) {
    var candidate = createRandom(CODE_LEN);
    if (!generated[candidate]) {
      generated[candidate] = 1;
      if (howMany % 100000 === 0) {
        // console.log('To Generate (2)', howMany);
      }
      howMany += -1;
    } else {
      // console.log('Collision...');
    }
  }
  var myGenerated = [];
  for (var k in generated) {
    myGenerated.push(k);
  }
  return myGenerated;
};

router.post('/getCodes', function (req, res, next) {
  var dbConnection = req.dbConnection,
      ip = req.ip;
  // console.log('req.body');

  var toGenerate = parseInt(req.body.toGenerate, 10);
  var bookingName = req.body.bookingName;
  if (toGenerate < 1 || !bookingName || bookingName.length < 1) {
    next('Wrong parameters!');
    return;
  }
  new Promise(function (resolve, reject) {
    dbConnection.query('SELECT count(*) as total FROM codiciUnivociVIVR WHERE bookingName = ' + dbConnection.escape(bookingName)).then( // Preliminary checks
    function (result) {
      // console.log('Query', `SELECT count(*) as total FROM codiciUnivociVIVR WHERE bookingName = ${dbConnection.escape(bookingName)}`);
      if (result && result[0].total > 0) {
        return Promise.reject('bookingName ' + bookingName + ' is not unique');
      }
      return Promise.resolve();
    }, function (e) {
      return Promise.reject(e);
    }).then(function () {
      var sql = 'SELECT len FROM codiciUnivociVIVRReport WHERE threshold - count > ' + dbConnection.escape(toGenerate) + ' ORDER BY len ASC LIMIT 1';
      return dbConnection.query(sql).then(function (results) {
        if (results && results[0].len > 0) {
          return Promise.resolve(results[0].len);
        }
        return Promise.reject();
      }, function (e) {
        // console.log('Ex', e);
        return Promise.reject(e);
      });
    }, function (e) {
      return Promise.reject(e);
    }).then( // Generate SQL INSERT
    function (CODE_LEN) {
      var created = 0;
      var loop = 0;
      var nowDate = (0, _moment2.default)().format('YYYY-MM-DD HH:mm:ss');
      return new Promise(function (inRes, inRej) {
        _async2.default.whilst(function () {
          loop += 1;
          return created < Math.min(toGenerate, MAX_CODES);
        }, function (cb) {
          var toCreate = getCodes(Math.min(Math.min(toGenerate, MAX_CODES) - created, CODES_CHUNK), CODE_LEN);
          var valueString = toCreate.map(function (v) {
            return '(' + dbConnection.escape(v) + ',' + dbConnection.escape(bookingName) + ',' + dbConnection.escape(ip) + ',' + dbConnection.escape(nowDate) + ')';
          });
          var sql = 'INSERT IGNORE into codiciUnivociVIVR (code, bookingName, bookingAddress, bookingDate) VALUES ' + valueString;
          dbConnection.query(sql).then(function (result) {
            created += result.affectedRows;
            cb(null);
          }, function (e) {
            cb(e);
          });
        }, function (e) {
          if (e) {
            inRej(e);
          } else {
            inRes(CODE_LEN);
          }
        });
      });
    }, function (e) {
      return Promise.reject(e);
    }).then(function (CODE_LEN) {
      var sql = 'SELECT code FROM codiciUnivociVIVR WHERE bookingName = ' + dbConnection.escape(bookingName);
      // console.log('SELECT SQL', sql);
      return dbConnection.query(sql).then(function (results) {
        // console.log('results', results);
        return Promise.resolve([results.map(function (c) {
          return c.code.toString();
        }), CODE_LEN]);
      }, function (e) {
        return Promise.reject(e);
      });
    }, function (e) {
      return Promise.reject(e);
    }).then(function (_ref) {
      var _ref2 = _slicedToArray(_ref, 2),
          validCodes = _ref2[0],
          CODE_LEN = _ref2[1];

      if (validCodes.length > 0) {
        var sql = 'UPDATE codiciUnivociVIVRReport SET count = count + ' + validCodes.length + ' WHERE len = ' + CODE_LEN;
        return dbConnection.query(sql).then(function () {
          return Promise.resolve(validCodes);
        }, function (e) {
          return Promise.reject(e);
        });
      }
      return Promise.resolve(validCodes);
    }, function (e) {
      return Promise.reject(e);
    }).then(function (validCodes) {
      console.info('[uniqueIds] Requested: ' + toGenerate + ', generated ' + validCodes.length);
      res.json(validCodes);
    }, function (e) {
      console.log('E', e);
      next(e);
    });
  });
});

exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvdW5pcXVlSWRzLmpzIl0sIm5hbWVzIjpbInJvdXRlciIsIlJvdXRlciIsIkNPREVTX0NIVU5LIiwiTUFYX0NPREVTIiwiY3JlYXRlUmFuZG9tIiwibCIsInN0cmluZyIsImxldHRlcnMiLCJpIiwicG9zIiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwibGVuZ3RoIiwiZ2V0Q29kZXMiLCJob3dNYW55IiwiQ09ERV9MRU4iLCJnZW5lcmF0ZWQiLCJjYW5kaWRhdGUiLCJteUdlbmVyYXRlZCIsImsiLCJwdXNoIiwicG9zdCIsInJlcSIsInJlcyIsIm5leHQiLCJkYkNvbm5lY3Rpb24iLCJpcCIsInRvR2VuZXJhdGUiLCJwYXJzZUludCIsImJvZHkiLCJib29raW5nTmFtZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwicXVlcnkiLCJlc2NhcGUiLCJ0aGVuIiwicmVzdWx0IiwidG90YWwiLCJlIiwic3FsIiwicmVzdWx0cyIsImxlbiIsImNyZWF0ZWQiLCJsb29wIiwibm93RGF0ZSIsImZvcm1hdCIsImluUmVzIiwiaW5SZWoiLCJ3aGlsc3QiLCJtaW4iLCJjYiIsInRvQ3JlYXRlIiwidmFsdWVTdHJpbmciLCJtYXAiLCJ2IiwiYWZmZWN0ZWRSb3dzIiwiYyIsImNvZGUiLCJ0b1N0cmluZyIsInZhbGlkQ29kZXMiLCJjb25zb2xlIiwiaW5mbyIsImpzb24iLCJsb2ciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7Ozs7O0FBRkEsSUFBTUEsU0FBUyxrQkFBUUMsTUFBUixFQUFmOztBQUdBLElBQU1DLGNBQWMsR0FBcEI7QUFDQSxJQUFNQyxZQUFZLEdBQWxCO0FBQ0EsSUFBTUMsZUFBZSxTQUFmQSxZQUFlLENBQVNDLENBQVQsRUFBWTtBQUNoQyxNQUFJQyxTQUFTLEVBQWI7QUFDQyxNQUFJQyxVQUFVLGdFQUFkO0FBQ0QsT0FBSyxJQUFJQyxJQUFJLENBQWIs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QkFBT0wsUUFBUUMsT0FBUixDQUFnQjRCLFVBQWhCLENBQVA7QUFDRCxTQUpJLEVBS0wsVUFBQ3JCLENBQUQ7QUFBQSxpQkFBT1IsUUFBUUUsTUFBUixDQUFlTSxDQUFmLENBQVA7QUFBQSxTQUxLLENBQVA7QUFPRDtBQUNELGFBQU9SLFFBQVFDLE9BQVIsQ0FBZ0I0QixVQUFoQixDQUFQO0FBQ0QsS0F0R0gsRUF1R0UsVUFBQ3JCLENBQUQ7QUFBQSxhQUFPUixRQUFRRSxNQUFSLENBQWVNLENBQWYsQ0FBUDtBQUFBLEtBdkdGLEVBeUdDSCxJQXpHRCxDQTBHRSxVQUFDd0IsVUFBRCxFQUFnQjtBQUNkQyxjQUFRQyxJQUFSLDZCQUF1Q25DLFVBQXZDLG9CQUFnRWlDLFdBQVdoRCxNQUEzRTtBQUNBVyxVQUFJd0MsSUFBSixDQUFTSCxVQUFUO0FBQ0QsS0E3R0gsRUE4R0UsVUFBQ3JCLENBQUQsRUFBTztBQUNMc0IsY0FBUUcsR0FBUixDQUFZLEdBQVosRUFBaUJ6QixDQUFqQjtBQUNBZixXQUFLZSxDQUFMO0FBQ0QsS0FqSEg7QUFtSEQsR0FwSEQ7QUFxSEQsQ0FqSUQ7O2tCQW1JZXhDLE0iLCJmaWxlIjoidW5pcXVlSWRzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCBjb25maWcgZnJvbSAnLi4vY29uZmlnL2NvbmZpZy5qc29uJztcclxuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9saWJzL2xvZ2dlcic7XHJcbmNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XHJcbmltcG9ydCBhc3luYyBmcm9tICdhc3luYyc7XHJcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50JztcclxuY29uc3QgQ09ERVNfQ0hVTksgPSAxMDA7XHJcbmNvbnN0IE1BWF9DT0RFUyA9IDUwMDtcclxuY29uc3QgY3JlYXRlUmFuZG9tID0gZnVuY3Rpb24obCkge1xyXG5cdHZhciBzdHJpbmcgPSAnJztcclxuICB2YXIgbGV0dGVycyA9ICdhYmNkZWZnaGlsbW5vcHFyc3R1dnp4d3lrakFCQ0RFRkdISUxNTk9QUVJTVFVWWlhXWUtKMTIzNDU2Nzg5MCc7XHJcblx0Zm9yICh2YXIgaSA9IDA7IGkgPCBsOyBpICs9IDEpIHtcclxuXHRcdHZhciBwb3MgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobGV0dGVycy5sZW5ndGggLSAwKSArIDApO1xyXG5cdFx0c3RyaW5nICs9IGxldHRlcnNbcG9zXTtcclxuXHR9XHJcblx0cmV0dXJuIHN0cmluZztcclxufVxyXG5jb25zdCBnZXRDb2RlcyA9IChob3dNYW55LCBDT0RFX0xFTikgPT4ge1xyXG4gIGNvbnN0IGdlbmVyYXRlZCA9IHt9O1xyXG4gIHdoaWxlIChob3dNYW55ID4gMCkge1xyXG4gICAgICAgICAgY29uc3QgY2FuZGlkYXRlID0gY3JlYXRlUmFuZG9tKENPREVfTEVOKTtcclxuICAgICAgICAgIGlmICghZ2VuZXJhdGVkW2NhbmRpZGF0ZV0pIHtcclxuICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVkW2NhbmRpZGF0ZV0gPSAxO1xyXG4gICAgICAgICAgICAgICAgICBpZiAoaG93TWFueSAlIDEwMDAwMCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdUbyBHZW5lcmF0ZSAoMiknLCBob3dNYW55KTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICBob3dNYW55ICs9IC0xO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ0NvbGxpc2lvbi4uLicpO1xyXG4gICAgICAgICAgfVxyXG4gIH1cclxuICBjb25zdCBteUdlbmVyYXRlZCA9IFtdO1xyXG4gIGZvciAobGV0IGsgaW4gZ2VuZXJhdGVkKSB7XHJcbiAgICBteUdlbmVyYXRlZC5wdXNoKGspO1xyXG4gIH1cclxuICByZXR1cm4gbXlHZW5lcmF0ZWQ7XHJcbn1cclxuXHJcbnJvdXRlci5wb3N0KCcvZ2V0Q29kZXMnLCAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICBjb25zdCB7XHJcbiAgICBkYkNvbm5lY3Rpb24sXHJcbiAgICBpcFxyXG4gIH0gPSByZXE7XHJcbiAgLy8gY29uc29sZS5sb2coJ3JlcS5ib2R5Jyk7XHJcbiAgY29uc3QgdG9HZW5lcmF0ZSA9IHBhcnNlSW50KHJlcS5ib2R5LnRvR2VuZXJhdGUsIDEwKTtcclxuICBjb25zdCBib29raW5nTmFtZSA9IHJlcS5ib2R5LmJvb2tpbmdOYW1lO1xyXG4gIGlmICh0b0dlbmVyYXRlIDwgMSB8fCAhYm9va2luZ05hbWUgfHwgYm9va2luZ05hbWUubGVuZ3RoIDwgMSkge1xyXG4gICAgbmV4dCgnV3JvbmcgcGFyYW1ldGVycyEnKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcbiAgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgZGJDb25uZWN0aW9uLnF1ZXJ5KGBTRUxFQ1QgY291bnQoKikgYXMgdG90YWwgRlJPTSBjb2RpY2lVbml2b2NpVklWUiBXSEVSRSBib29raW5nTmFtZSA9ICR7ZGJDb25uZWN0aW9uLmVzY2FwZShib29raW5nTmFtZSl9YClcclxuICAgIC50aGVuKCAvLyBQcmVsaW1pbmFyeSBjaGVja3NcclxuICAgICAgKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdRdWVyeScsIGBTRUxFQ1QgY291bnQoKikgYXMgdG90YWwgRlJPTSBjb2RpY2lVbml2b2NpVklWUiBXSEVSRSBib29raW5nTmFtZSA9ICR7ZGJDb25uZWN0aW9uLmVzY2FwZShib29raW5nTmFtZSl9YCk7XHJcbiAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHRbMF0udG90YWwgPiAwKSB7XHJcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYGJvb2tpbmdOYW1lICR7Ym9va2luZ05hbWV9IGlzIG5vdCB1bmlxdWVgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgICB9LFxyXG4gICAgICAoZSkgPT4gUHJvbWlzZS5yZWplY3QoZSlcclxuICAgIClcclxuICAgIC50aGVuKFxyXG4gICAgICAoKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc3FsID0gYFNFTEVDVCBsZW4gRlJPTSBjb2RpY2lVbml2b2NpVklWUlJlcG9ydCBXSEVSRSB0aHJlc2hvbGQgLSBjb3VudCA+ICR7ZGJDb25uZWN0aW9uLmVzY2FwZSh0b0dlbmVyYXRlKX0gT1JERVIgQlkgbGVuIEFTQyBMSU1JVCAxYDtcclxuICAgICAgICByZXR1cm4gZGJDb25uZWN0aW9uLnF1ZXJ5KHNxbClcclxuICAgICAgICAudGhlbihcclxuICAgICAgICAgIChyZXN1bHRzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHRzICYmIHJlc3VsdHNbMF0ubGVuID4gMCkge1xyXG4gICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0c1swXS5sZW4pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgpO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIChlKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdFeCcsIGUpO1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKVxyXG4gICAgICB9LFxyXG4gICAgICAoZSkgPT4gUHJvbWlzZS5yZWplY3QoZSlcclxuICAgIClcclxuICAgIC50aGVuKCAvLyBHZW5lcmF0ZSBTUUwgSU5TRVJUXHJcbiAgICAgIChDT0RFX0xFTikgPT4ge1xyXG4gICAgICAgIGxldCBjcmVhdGVkID0gMDtcclxuICAgICAgICBsZXQgbG9vcCA9IDA7XHJcbiAgICAgICAgY29uc3Qgbm93RGF0ZSA9IG1vbWVudCgpLmZvcm1hdCgnWVlZWS1NTS1ERCBISDptbTpzcycpO1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgoaW5SZXMsIGluUmVqKSA9PiB7XHJcbiAgICAgICAgICBhc3luYy53aGlsc3QoXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICBsb29wICs9IDE7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQgPCBNYXRoLm1pbih0b0dlbmVyYXRlLCBNQVhfQ09ERVMpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAoY2IpID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCB0b0NyZWF0ZSA9IGdldENvZGVzKE1hdGgubWluKE1hdGgubWluKHRvR2VuZXJhdGUsIE1BWF9DT0RFUykgLSBjcmVhdGVkLCBDT0RFU19DSFVOSyksIENPREVfTEVOKTtcclxuICAgICAgICAgICAgICBjb25zdCB2YWx1ZVN0cmluZyA9IHRvQ3JlYXRlLm1hcCgodikgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGAoJHtkYkNvbm5lY3Rpb24uZXNjYXBlKHYpfSwke2RiQ29ubmVjdGlvbi5lc2NhcGUoYm9va2luZ05hbWUpfSwke2RiQ29ubmVjdGlvbi5lc2NhcGUoaXApfSwke2RiQ29ubmVjdGlvbi5lc2NhcGUobm93RGF0ZSl9KWA7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgY29uc3Qgc3FsID0gYElOU0VSVCBJR05PUkUgaW50byBjb2RpY2lVbml2b2NpVklWUiAoY29kZSwgYm9va2luZ05hbWUsIGJvb2tpbmdBZGRyZXNzLCBib29raW5nRGF0ZSkgVkFMVUVTICR7dmFsdWVTdHJpbmd9YDtcclxuICAgICAgICAgICAgICBkYkNvbm5lY3Rpb24ucXVlcnkoc3FsKVxyXG4gICAgICAgICAgICAgIC50aGVuKFxyXG4gICAgICAgICAgICAgICAgKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBjcmVhdGVkICs9IHJlc3VsdC5hZmZlY3RlZFJvd3M7XHJcbiAgICAgICAgICAgICAgICAgIGNiKG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGNiKGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgKGUpID0+IHtcclxuICAgICAgICAgICAgICBpZiAoZSkge1xyXG4gICAgICAgICAgICAgICAgaW5SZWooZSk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGluUmVzKENPREVfTEVOKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIChlKSA9PiBQcm9taXNlLnJlamVjdChlKVxyXG4gICAgKVxyXG4gICAgLnRoZW4oXHJcbiAgICAgIChDT0RFX0xFTikgPT4ge1xyXG4gICAgICAgIGNvbnN0IHNxbCA9IGBTRUxFQ1QgY29kZSBGUk9NIGNvZGljaVVuaXZvY2lWSVZSIFdIRVJFIGJvb2tpbmdOYW1lID0gJHtkYkNvbm5lY3Rpb24uZXNjYXBlKGJvb2tpbmdOYW1lKX1gO1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdTRUxFQ1QgU1FMJywgc3FsKTtcclxuICAgICAgICByZXR1cm4gZGJDb25uZWN0aW9uLnF1ZXJ5KHNxbClcclxuICAgICAgICAudGhlbihcclxuICAgICAgICAgIChyZXN1bHRzKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdyZXN1bHRzJywgcmVzdWx0cyk7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW3Jlc3VsdHMubWFwKChjKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGMuY29kZS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICB9KSwgQ09ERV9MRU5dKTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICAoZSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgfSxcclxuICAgICAgKGUpID0+IFByb21pc2UucmVqZWN0KGUpXHJcbiAgICApXHJcbiAgICAudGhlbihcclxuICAgICAgKFt2YWxpZENvZGVzLCBDT0RFX0xFTl0pID0+IHtcclxuICAgICAgICBpZiAodmFsaWRDb2Rlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBjb25zdCBzcWwgPSBgVVBEQVRFIGNvZGljaVVuaXZvY2lWSVZSUmVwb3J0IFNFVCBjb3VudCA9IGNvdW50ICsgJHt2YWxpZENvZGVzLmxlbmd0aH0gV0hFUkUgbGVuID0gJHtDT0RFX0xFTn1gO1xyXG4gICAgICAgICAgcmV0dXJuIGRiQ29ubmVjdGlvbi5xdWVyeShzcWwpXHJcbiAgICAgICAgICAudGhlbihcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodmFsaWRDb2Rlcyk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIChlKSA9PiBQcm9taXNlLnJlamVjdChlKVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh2YWxpZENvZGVzKTtcclxuICAgICAgfSxcclxuICAgICAgKGUpID0+IFByb21pc2UucmVqZWN0KGUpXHJcbiAgICApXHJcbiAgICAudGhlbihcclxuICAgICAgKHZhbGlkQ29kZXMpID0+IHtcclxuICAgICAgICBjb25zb2xlLmluZm8oYFt1bmlxdWVJZHNdIFJlcXVlc3RlZDogJHt0b0dlbmVyYXRlfSwgZ2VuZXJhdGVkICR7dmFsaWRDb2Rlcy5sZW5ndGh9YCk7XHJcbiAgICAgICAgcmVzLmpzb24odmFsaWRDb2Rlcyk7XHJcbiAgICAgIH0sXHJcbiAgICAgIChlKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ0UnLCBlKTtcclxuICAgICAgICBuZXh0KGUpO1xyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH0pO1xyXG59KTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IHJvdXRlcjtcclxuIl19